<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Respuesta - Blends</title>
  <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
  <main>
    <h1 id="status">Procesando respuesta...</h1>
    <div id="debug"></div>
  </main>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/cart.js"></script>
  <script src="assets/js/storage.js"></script>

  <script>
    // Función para leer la URL
    function getQuery() {
      return new URLSearchParams(window.location.search);
    }

    (async function () {
      const qs = getQuery();
      // Captura la referencia de ePayco
      const ref = qs.get('ref_payco') || qs.get('x_ref_payco');
      const statusElement = document.getElementById('status');

      if (!ref) {
        statusElement.innerText = 'No se encontró referencia de pago.';
        return;
      }

      try {
        // 1. Consultamos a ePayco el estado REAL de esa referencia
        const response = await fetch(`https://api.secure.payco.co/validation/v1/reference/${ref}`);
        const resData = await response.json();

        if (resData.success && resData.data) {
          const p = resData.data;
          // x_cod_response: 1=Aceptado, 2=Rechazado, 3=Pendiente, 4=Fallido
          const codRes = parseInt(p.x_cod_response);

          if (codRes === 1) {
            statusElement.innerText = '¡Pago aprobado! Registrando en el sistema...';

            // 2. Preparamos los datos EXACTOS para SheetDB
            // IMPORTANTE: Estos nombres deben ser iguales a los encabezados de tu Excel
            const datosPedido = {
              ref_payco: p.x_ref_payco,
              estado: p.x_response,
              extra1: p.x_extra1,      // Nombre
              extra2: p.x_extra2,      // Dirección | Ciudad
              extra3: p.x_extra3,      // Teléfono
              email: p.x_customer_email || p.x_email,
              total: p.x_amount,
              items: p.x_description   // Las gorras compradas
            };

            // 3. Enviamos a SheetDB usando la función de storage.js
            await guardarPedido(datosPedido);
            
            statusElement.innerText = '¡Pedido registrado con éxito en Google Sheets!';
            Cart.clear(); // Limpiamos el carrito local
          } else {
            statusElement.innerText = `Estado del pago: ${p.x_response} (Código: ${codRes})`;
          }
        } else {
          statusElement.innerText = 'No se pudo validar la información con ePayco.';
        }
      } catch (err) {
        statusElement.innerText = 'Error en la comunicación con el sistema.';
        console.error(err);
      }
    })();
  </script>
</body>
</html>
